//= ========================= Load Modules Start ===========================

//= ========================= Load external Module =========================

const _ = require("lodash");

//= ========================= Load internal Module =========================

const constants = require("../constants");
const jwtHandler = require("../jwtHandler");
const exceptions = require("../customExceptions");

//= ========================= Load Modules End =============================

function authorizeRoles(authorizedRoles = []) {
  return function (req, res, next) {
    const acsToken = req.get("Authorization");

    console.log(`acsToken ${acsToken}`);
    return jwtHandler.verifyJwtToken(acsToken)
      .then((tokenPayload) => {
        req.user = tokenPayload;
        const role = tokenPayload.rid;
        if (authorizedRoles.includes(role)) {
          next();
        } else {
          throw exceptions.unAuthenticatedAccess(constants.MESSAGES.invalid_authorization);
        }
      }).catch((err) => {
        const error = {};
        error.errorCode = 1;
        error.msg = constants.MESSAGES.invalid_authorization;
        next(error);
      });
  };
}

//= ========================= Export Module Start ===========================

module.exports = {
  authorizeRoles,
};

//= ========================= Export Module End ===========================

